# Build and deploy cloud service to production
# Triggered when a version tag (cloud-v*) is pushed
name: "Release: Deploy to Production"

on:
  push:
    tags:
      - "cloud-v*" # e.g., cloud-v0.2.0
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., cloud-v0.2.0)"
        required: true

concurrency:
  group: release-cloud
  cancel-in-progress: false

permissions:
  contents: read
  actions: read

jobs:
  wait-for-app:
    name: Wait for App Build
    runs-on: ubuntu-latest
    outputs:
      app-version: ${{ steps.version.outputs.version }}
      app-version-num: ${{ steps.version.outputs.version_num }}
    steps:
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          VERSION_NUM="${VERSION#cloud-v}"
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          APP_VERSION="app-${VERSION_NUM}"
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT

      - name: Wait for App Workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        id: wait
        with:
          ref: ${{ steps.version.outputs.app_version }}
          repo: brewos-io/app
          check-name: 'Build App'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

      - name: Get App Commit SHA
        id: get-sha
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ steps.version.outputs.app_version }}';
            
            // Get the commit SHA for the tag
            const { data: ref } = await github.rest.git.getRef({
              owner: 'brewos-io',
              repo: 'app',
              ref: `tags/${tag}`
            });
            
            const commitSha = ref.object.sha;
            console.log(`Tag ${tag} points to commit: ${commitSha}`);
            core.setOutput('commit_sha', commitSha);

      - name: Download App Artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: release.yml
          workflow_conclusion: success
          commit: ${{ steps.get-sha.outputs.commit_sha }}
          name: app-cloud-${{ steps.version.outputs.app_version }}
          path: app-build
          repo: brewos-io/app
          if_no_artifact_found: fail

      - name: Upload App Build for Deployment
        uses: actions/upload-artifact@v6
        with:
          name: app-build-for-deploy
          path: app-build/
          retention-days: 1

  deploy-production:
    needs: wait-for-app
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://cloud.brewos.io
    steps:
      - name: Determine ref to checkout
        id: ref
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ref=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          VERSION_NUM="${VERSION#cloud-v}"
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT

      - name: Download App Build Artifact
        uses: actions/download-artifact@v6
        with:
          name: app-build-for-deploy
          path: app-build

      - name: Upload App Build to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_SSH_HOST || 'cloud.brewos.io' }}
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "app-build/*"
          target: "/tmp/app-build"
          strip_components: 0

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.4
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        with:
          host: ${{ secrets.SERVER_SSH_HOST || 'cloud.brewos.io' }}
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: GOOGLE_CLIENT_ID,RELEASE_VERSION
          command_timeout: 15m
          script: |
            set -e
            
            # Clone repository if it doesn't exist
            if [ ! -d "/root/brewos-cloud" ]; then
              echo "Cloning cloud repository..."
              git clone https://github.com/brewos-io/cloud.git /root/brewos-cloud
            fi
            
            cd /root/brewos-cloud

            # Clean up any local changes
            git reset --hard
            git clean -fd

            # Fetch the release tag
            git fetch origin --tags --force
            git checkout ${RELEASE_VERSION}

            # Copy pre-built app from uploaded artifact
            rm -rf web
            mkdir -p web
            cp -r /tmp/app-build/* web/
            rm -rf /tmp/app-build

            # Create .env for cloud service
            cat > .env << EOF
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            PORT=3001
            DATA_DIR=/data
            TRUST_PROXY=true
            APP_DIST_PATH=./web
            EOF

            # Build Admin UI
            cd admin
            npm ci
            npm run build
            cd ..

            # Get version from package.json for logging
            VERSION=$(node -p "require('./package.json').version")
            echo "Building cloud service version: $VERSION"

            # Build Docker image
            if [ -f "scripts/docker-build.sh" ]; then
              bash scripts/docker-build.sh
            else
              docker build -t brewos-cloud:latest .
            fi

            # Tag image with version
            docker tag brewos-cloud:latest brewos-cloud:$VERSION || true

            # Restart service
            docker compose down
            docker compose up -d

            # Wait for service to be healthy
            echo "Waiting for service to start..."
            sleep 5

            for i in 1 2 3 4 5; do
              if curl -sf http://localhost:3001/api/health > /dev/null; then
                echo "✓ Production service is healthy!"
                echo "  Deployed version: ${RELEASE_VERSION}"
                docker system prune -af --filter "until=1h" || true
                exit 0
              fi
              echo "Waiting... ($i/5)"
              sleep 3
            done

            echo "✗ Health check failed!"
            docker compose logs --tail=50
            exit 1

