# Deploy to STAGING on push to main
# Production deploys happen via release.yml when a version tag is pushed
name: "Main → Deploy to Staging"

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "admin/**"
      - "package.json"
      - ".github/workflows/deploy-staging.yml"

# Only allow one deploy at a time - cancel older runs
concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  build-check:
    name: Verify Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            admin/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npx tsc --noEmit

      - name: Build Cloud Service
        run: npm run build

      - name: Install Admin Dependencies
        working-directory: admin
        run: npm ci

      - name: Build Admin UI
        working-directory: admin
        run: npm run build

  deploy-staging:
    name: Deploy to Staging
    needs: build-check
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.brewos.io
    steps:
      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.2.4
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        with:
          host: ${{ secrets.STAGING_SSH_HOST || 'staging.brewos.io' }}
          username: root
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}
          envs: GOOGLE_CLIENT_ID
          command_timeout: 15m
          script: |
            set -e
            
            # Clone repository if it doesn't exist
            if [ ! -d "/root/brewos-cloud" ]; then
              echo "Cloning cloud repository..."
              git clone https://github.com/brewos-io/cloud.git /root/brewos-cloud
            fi
            
            cd /root/brewos-cloud

            # Reset to match repo exactly
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # Checkout app repository for build
            if [ ! -d "../app" ]; then
              git clone https://github.com/brewos-io/app.git ../app
            fi
            cd ../app
            git fetch origin main
            git checkout main
            git pull origin main

            # Build app for cloud
            npm ci
            cat > .env << EOF
            VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            VITE_CLOUD_WS_URL=wss://staging.brewos.io/ws
            VITE_ENVIRONMENT=staging
            EOF
            NODE_OPTIONS="--max-old-space-size=4096" npm run build

            # Copy built app to cloud service
            cd ../brewos-cloud
            rm -rf web
            cp -r ../app/dist web

            # Create .env for cloud service
            cat > .env << EOF
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            PORT=3001
            DATA_DIR=/data
            TRUST_PROXY=true
            APP_DIST_PATH=./web
            EOF

            # Build Admin UI
            cd admin
            npm ci
            npm run build
            cd ..

            # Get version from package.json for logging
            VERSION=$(node -p "require('./package.json').version")
            echo "Building cloud service version: $VERSION"

            # Build Docker image
            if [ -f "scripts/docker-build.sh" ]; then
              bash scripts/docker-build.sh
            else
              docker build -t brewos-cloud:latest .
            fi

            # Tag image with version
            docker tag brewos-cloud:latest brewos-cloud:$VERSION || true

            # Restart service
            docker compose down
            docker compose up -d

            # Wait for service to be healthy
            echo "Waiting for service to start..."
            sleep 5

            for i in 1 2 3 4 5; do
              if curl -sf http://localhost:3001/api/health > /dev/null; then
                echo "✓ Staging service is healthy!"
                docker system prune -af --filter "until=1h" || true
                exit 0
              fi
              echo "Waiting... ($i/5)"
              sleep 3
            done

            echo "✗ Health check failed!"
            docker compose logs --tail=50
            exit 1

